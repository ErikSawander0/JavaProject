<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets">

<h:head>
    <title>Admin – Menyhantering</title>
    <h:outputStylesheet library="css" name="menu-admin.css"/>
</h:head>

<h:body>

    <div class="admin-container">

        <h1>Admin – Menyhantering</h1>

        <!-- Navigation -->
        <div class="admin-nav">
            <h:link value="Schemaläggning →" outcome="schedule-admin" styleClass="nav-link"/>
        </div>

        <!-- ========================= -->
        <!--      MENU ITEMS LIST      -->
        <!-- ========================= -->
        <h2>Menyobjekt</h2>

        <h:form id="menuItemsForm">
            <table class="admin-table">
                <thead>
                <tr>
                    <th>Namn</th>
                    <th>Pris</th>
                    <th>Vegan</th>
                    <th>Glutenfri</th>
                    <th>À la carte</th>
                    <th>Åtgärder</th>
                </tr>
                </thead>
                <tbody>
                <ui:repeat value="#{adminBean.menuItems}" var="item">
                    <tr>
                        <td>
                            <h:panelGroup rendered="#{!adminBean.isEditing(item)}">#{item.name}</h:panelGroup>
                            <h:panelGroup rendered="#{adminBean.isEditing(item)}">
                                <h:inputText value="#{adminBean.editingMenuItem.name}"/>
                                <div style="margin-top: 4px;">
                                    <label>Beskrivning:</label>
                                    <h:inputTextarea value="#{adminBean.editingMenuItem.description}" rows="2"/>
                                </div>
                            </h:panelGroup>
                        </td>
                        <td>
                            <h:panelGroup rendered="#{!adminBean.isEditing(item)}">#{item.price}</h:panelGroup>
                            <h:panelGroup rendered="#{adminBean.isEditing(item)}">
                                <h:inputText value="#{adminBean.editingMenuItem.price}" size="6"/>
                            </h:panelGroup>
                        </td>
                        <td>
                            <h:panelGroup rendered="#{!adminBean.isEditing(item)}">#{item.isVegan ? 'Ja' : 'Nej'}</h:panelGroup>
                            <h:panelGroup rendered="#{adminBean.isEditing(item)}">
                                <h:selectBooleanCheckbox value="#{adminBean.editingMenuItem.isVegan}"/>
                            </h:panelGroup>
                        </td>
                        <td>
                            <h:panelGroup rendered="#{!adminBean.isEditing(item)}">#{item.isGlutenFree ? 'Ja' : 'Nej'}</h:panelGroup>
                            <h:panelGroup rendered="#{adminBean.isEditing(item)}">
                                <h:selectBooleanCheckbox value="#{adminBean.editingMenuItem.isGlutenFree}"/>
                            </h:panelGroup>
                        </td>
                        <td>
                            <h:panelGroup rendered="#{!adminBean.isEditing(item)}">#{adminBean.hasCarteAttributes(item) ? '✓' : '–'}</h:panelGroup>
                            <h:panelGroup rendered="#{adminBean.isEditing(item)}">
                                <h:panelGroup rendered="#{adminBean.hasCarteAttributes(item)}">
                                    <div>Aktiv tid: <h:inputText value="#{adminBean.editingMenuItem.carteAtributes.activeTime}" size="3"/></div>
                                    <div>Väntetid: <h:inputText value="#{adminBean.editingMenuItem.carteAtributes.waitingTime}" size="3"/></div>
                                    <div>Förrätt: <h:selectBooleanCheckbox value="#{adminBean.editingMenuItem.carteAtributes.isAppetizer}"/></div>
                                    <div>Huvudrätt: <h:selectBooleanCheckbox value="#{adminBean.editingMenuItem.carteAtributes.isHuvud}"/></div>
                                    <div>Dessert: <h:selectBooleanCheckbox value="#{adminBean.editingMenuItem.carteAtributes.isDessert}"/></div>
                                    <div>Kött: <h:selectBooleanCheckbox value="#{adminBean.editingMenuItem.carteAtributes.isMeat}"/></div>
                                    <div>Kan ersättas: <h:selectBooleanCheckbox value="#{adminBean.editingMenuItem.carteAtributes.canSubstitute}"/></div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{!adminBean.hasCarteAttributes(item)}">–</h:panelGroup>
                            </h:panelGroup>
                        </td>
                        <td>
                            <h:panelGroup rendered="#{!adminBean.isEditing(item)}">
                                <h:commandButton value="Redigera"
                                                 action="#{adminBean.startEditMenuItem(item)}"
                                                 styleClass="secondary-btn">
                                    <f:ajax execute="@this" render="@form"/>
                                </h:commandButton>
                                <h:commandButton value="Ta bort"
                                                 action="#{adminBean.removeMenuItem(item)}"
                                                 styleClass="danger-btn">
                                    <f:ajax execute="@this" render="@form :addItemToDailyMenuForm :addItemToCarteMenuForm"/>
                                </h:commandButton>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{adminBean.isEditing(item)}">
                                <h:commandButton value="Spara"
                                                 action="#{adminBean.saveEditMenuItem}"
                                                 styleClass="primary-btn">
                                    <f:ajax execute="@form" render="@form"/>
                                </h:commandButton>
                                <h:commandButton value="Avbryt"
                                                 action="#{adminBean.cancelEditMenuItem}"
                                                 styleClass="secondary-btn"
                                                 immediate="true">
                                    <f:ajax execute="@this" render="@form"/>
                                </h:commandButton>
                            </h:panelGroup>
                        </td>
                    </tr>
                </ui:repeat>
                </tbody>

            </table>
        </h:form>


        <!-- ========================= -->
        <!--     ADD MENU ITEM FORM   -->
        <!-- ========================= -->
        <h3>Lägg till menyobjekt</h3>

        <h:form styleClass="form-card" id="addMenuItemForm">

            <div class="form-row">
                <label>Namn:</label>
                <h:inputText value="#{adminBean.newMenuItem.name}" />
            </div>

            <div class="form-row">
                <label>Beskrivning:</label>
                <h:inputTextarea value="#{adminBean.newMenuItem.description}" rows="3"/>
            </div>

            <div class="form-row">
                <label>Pris:</label>
                <h:inputText value="#{adminBean.newMenuItem.price}" />
            </div>

            <div class="form-row">
                <label>Vegan:</label>
                <h:selectBooleanCheckbox value="#{adminBean.newMenuItem.isVegan}" />
            </div>
            <div class="form-row">
                <label>Glutenfri:</label>
                <h:selectBooleanCheckbox value="#{adminBean.newMenuItem.isGlutenFree}" />
            </div>
            <div class="form-row">
                <label>Allergener:</label>
                <h:inputText value="#{adminBean.newMenuItem.allergens}" />
            </div>

            <div class="form-row center">
                <h:commandButton value="Lägg till"
                                 action="#{adminBean.addMenuItem}"
                                 styleClass="primary-btn">
                    <f:ajax execute="@form" render="@form :menuItemsForm :addItemToDailyMenuForm :addItemToCarteMenuForm" resetValues="true"/>
                </h:commandButton>
            </div>

        </h:form>


        <!-- ========================= -->
        <!--      DAILY MENUS LIST     -->
        <!-- ========================= -->
        <h2>Dagens Menyer</h2>

        <h:form id="dailyMenusForm">
            <table class="admin-table">
                <thead>
                <tr>
                    <th>Datum</th>
                    <th>Rätter</th>
                    <th>Åtgärder</th>
                </tr>
                </thead>

                <tbody>
                <ui:repeat value="#{adminBean.dailyMenus}" var="dm">
                    <tr>
                        <td>#{dm.date}</td>
                        <td>
                            <ul class="menu-item-list">
                                <ui:repeat value="#{dm.menuItems}" var="item">
                                    <li>
                                        #{item.name}
                                        <h:commandButton value="✕"
                                                         action="#{adminBean.removeMenuItemFromDailyMenuById}"
                                                         styleClass="remove-item-btn"
                                                         title="Ta bort från meny">
                                            <f:setPropertyActionListener target="#{adminBean.selectedDailyMenuId}" value="#{dm.id}"/>
                                            <f:setPropertyActionListener target="#{adminBean.selectedMenuItemId}" value="#{item.id}"/>
                                            <f:ajax execute="@this" render="@form"/>
                                        </h:commandButton>
                                    </li>
                                </ui:repeat>
                            </ul>
                        </td>
                        <td>
                            <h:commandButton value="Ta bort meny"
                                             action="#{adminBean.removeDailyMenu(dm)}"
                                             styleClass="danger-btn">
                                <f:ajax execute="@this" render="@form :addItemToDailyMenuForm"/>
                            </h:commandButton>
                        </td>
                    </tr>
                </ui:repeat>
                </tbody>
            </table>
        </h:form>


        <!-- ========================= -->
        <!--   CREATE DAILY MENU FORM  -->
        <!-- ========================= -->
        <h3>Skapa ny Dagens meny</h3>

        <h:form styleClass="form-inline" id="createDailyMenuForm">
            <label>Datum:</label>
            <h:inputText type="date" value="#{adminBean.newDailyMenu.date}">
                <f:convertDateTime type="localDate" pattern="yyyy-MM-dd" timeZone=""/>
            </h:inputText>

            <h:commandButton value="Skapa"
                             action="#{adminBean.addDailyMenu}"
                             styleClass="primary-btn">
                <f:ajax execute="@form" render="@form :dailyMenusForm :addItemToDailyMenuForm" resetValues="true"/>
            </h:commandButton>
        </h:form>


        <!-- ========================= -->
        <!-- ADD ITEM TO DAILY MENU    -->
        <!-- ========================= -->
        <h3>Lägg till rätt i dagens meny</h3>

        <h:form styleClass="form-inline" id="addItemToDailyMenuForm">

            <label>Menyobjekt:</label>
            <h:selectOneMenu value="#{adminBean.selectedMenuItemId}">
                <f:selectItem itemLabel="-- Välj --" itemValue="#{null}" noSelectionOption="true"/>
                <f:selectItems value="#{adminBean.menuItems}" var="i"
                               itemValue="#{i.id}" itemLabel="#{i.name}"/>
            </h:selectOneMenu>

            <label>Dagens meny:</label>
            <h:selectOneMenu value="#{adminBean.selectedDailyMenuId}">
                <f:selectItem itemLabel="-- Välj --" itemValue="#{null}" noSelectionOption="true"/>
                <f:selectItems value="#{adminBean.dailyMenus}" var="dm"
                               itemValue="#{dm.id}" itemLabel="#{dm.date}"/>
            </h:selectOneMenu>

            <h:commandButton value="Lägg till"
                             action="#{adminBean.addMenuItemToDailyMenu}"
                             styleClass="primary-btn">
                <f:ajax execute="@form" render="@form :dailyMenusForm"/>
            </h:commandButton>

        </h:form>


        <!-- ========================= -->
        <!--      CARTE MENUS LIST     -->
        <!-- ========================= -->
        <h2>À la carte Menyer</h2>

        <h:form id="carteMenusForm">
            <table class="admin-table">
                <thead>
                <tr>
                    <th>Namn</th>
                    <th>Aktiv</th>
                    <th>Rätter</th>
                    <th>Åtgärder</th>
                </tr>
                </thead>

                <tbody>
                <ui:repeat value="#{adminBean.carteMenus}" var="cm">
                    <tr class="#{cm.active ? 'active-row' : ''}">
                        <td>#{cm.name}</td>
                        <td>
                            <h:commandButton value="#{cm.active ? '● Aktiv' : 'Aktivera'}"
                                             action="#{adminBean.setActiveCarteMenu(cm)}"
                                             styleClass="#{cm.active ? 'active-btn' : 'secondary-btn'}">
                                <f:ajax execute="@this" render="@form"/>
                            </h:commandButton>
                        </td>
                        <td>
                            <ul class="menu-item-list">
                                <ui:repeat value="#{cm.menuItems}" var="item">
                                    <li>
                                        #{item.name}
                                        <h:commandButton value="✕"
                                                         action="#{adminBean.removeMenuItemFromCarteMenuById}"
                                                         styleClass="remove-item-btn"
                                                         title="Ta bort från meny">
                                            <f:setPropertyActionListener target="#{adminBean.selectedCarteMenuId}" value="#{cm.id}"/>
                                            <f:setPropertyActionListener target="#{adminBean.selectedMenuItemId}" value="#{item.id}"/>
                                            <f:ajax execute="@this" render="@form"/>
                                        </h:commandButton>
                                    </li>
                                </ui:repeat>
                            </ul>
                        </td>
                        <td>
                            <h:commandButton value="Ta bort meny"
                                             action="#{adminBean.removeCarteMenu(cm)}"
                                             styleClass="danger-btn">
                                <f:ajax execute="@this" render="@form :addItemToCarteMenuForm"/>
                            </h:commandButton>
                        </td>
                    </tr>
                </ui:repeat>
                </tbody>
            </table>
        </h:form>


        <!-- ========================= -->
        <!--   CREATE CARTE MENU FORM  -->
        <!-- ========================= -->
        <h3>Skapa ny À la carte meny</h3>

        <h:form styleClass="form-inline" id="createCarteMenuForm">
            <label>Namn:</label>
            <h:inputText value="#{adminBean.newCarteMenu.name}"/>

            <h:commandButton value="Skapa"
                             action="#{adminBean.addCarteMenu}"
                             styleClass="primary-btn">
                <f:ajax execute="@form" render="@form :carteMenusForm :addItemToCarteMenuForm" resetValues="true"/>
            </h:commandButton>
        </h:form>


        <!-- ========================= -->
        <!-- ADD ITEM TO CARTE MENU    -->
        <!-- ========================= -->
        <h3>Lägg till rätt i à la carte meny</h3>

        <h:form styleClass="form-inline" id="addItemToCarteMenuForm">

            <label>Menyobjekt (endast à la carte):</label>
            <h:selectOneMenu value="#{adminBean.selectedMenuItemId}">
                <f:selectItem itemLabel="-- Välj --" itemValue="#{null}" noSelectionOption="true"/>
                <f:selectItems value="#{adminBean.carteEligibleMenuItems}" var="i"
                               itemValue="#{i.id}" itemLabel="#{i.name}"/>
            </h:selectOneMenu>

            <label>À la carte meny:</label>
            <h:selectOneMenu value="#{adminBean.selectedCarteMenuId}">
                <f:selectItem itemLabel="-- Välj --" itemValue="#{null}" noSelectionOption="true"/>
                <f:selectItems value="#{adminBean.carteMenus}" var="cm"
                               itemValue="#{cm.id}" itemLabel="#{cm.name}"/>
            </h:selectOneMenu>

            <h:commandButton value="Lägg till"
                             action="#{adminBean.addMenuItemToCarteMenu}"
                             styleClass="primary-btn">
                <f:ajax execute="@form" render="@form :carteMenusForm"/>
            </h:commandButton>

        </h:form>


        <!-- ========================= -->
        <!--  ADD CARTE ATTRIBUTES     -->
        <!-- ========================= -->
        <h3>Gör menyobjekt à la carte-redo</h3>

        <h:form styleClass="form-card" id="addCarteAttributesForm">

            <div class="form-row">
                <label>Menyobjekt:</label>
                <h:selectOneMenu value="#{adminBean.selectedMenuItemIdForCarte}">
                    <f:selectItem itemLabel="-- Välj --" itemValue="#{null}" noSelectionOption="true"/>
                    <f:selectItems value="#{adminBean.menuItemsWithoutCarteAttributes}" var="i"
                                   itemValue="#{i.id}" itemLabel="#{i.name}"/>
                </h:selectOneMenu>
            </div>

            <div class="form-row">
                <label>Aktiv tid (min):</label>
                <h:inputText value="#{adminBean.newCarteAttributes.activeTime}" />
            </div>

            <div class="form-row">
                <label>Väntetid (min):</label>
                <h:inputText value="#{adminBean.newCarteAttributes.waitingTime}" />
            </div>

            <div class="form-row">
                <label>Förrätt:</label>
                <h:selectBooleanCheckbox value="#{adminBean.newCarteAttributes.isAppetizer}" />
            </div>

            <div class="form-row">
                <label>Huvudrätt:</label>
                <h:selectBooleanCheckbox value="#{adminBean.newCarteAttributes.isHuvud}" />
            </div>

            <div class="form-row">
                <label>Dessert:</label>
                <h:selectBooleanCheckbox value="#{adminBean.newCarteAttributes.isDessert}" />
            </div>

            <div class="form-row">
                <label>Kött:</label>
                <h:selectBooleanCheckbox value="#{adminBean.newCarteAttributes.isMeat}" />
            </div>

            <div class="form-row">
                <label>Kan ersättas:</label>
                <h:selectBooleanCheckbox value="#{adminBean.newCarteAttributes.canSubstitute}" />
            </div>

            <div class="form-row center">
                <h:commandButton value="Spara"
                                 action="#{adminBean.addCarteAttributes}"
                                 styleClass="primary-btn">
                    <f:ajax execute="@form" render="@form :menuItemsForm :addItemToCarteMenuForm" resetValues="true"/>
                </h:commandButton>
            </div>

        </h:form>


        <!-- ========================= -->
        <!--      BLOG ENTRIES         -->
        <!-- ========================= -->
        <h2>Admin – Blogginlägg</h2>

        <h:form id="blogEntriesForm">
            <table class="admin-table">
                <thead>
                <tr>
                    <th>Bild</th>
                    <th>Titel</th>
                    <th>Datum</th>
                    <th>Åtgärder</th>
                </tr>
                </thead>

                <tbody>
                <ui:repeat value="#{adminBean.blogEntries}" var="blog">
                    <tr>
                        <td>
                            <h:graphicImage value="data:image/png;base64,#{adminBean.getPictureAsBase64(blog.picture)}" width="50"/>
                        </td>
                        <td>#{blog.title}</td>
                        <td>#{blog.date}</td>
                        <td>
                            <h:commandButton value="Ta bort"
                                             action="#{adminBean.removeBlogEntry(blog)}"
                                             styleClass="danger-btn">
                                <f:ajax execute="@this" render="@form"/>
                            </h:commandButton>
                        </td>
                    </tr>
                </ui:repeat>
                </tbody>
            </table>
        </h:form>


        <!-- ========================= -->
        <!--   CREATE BLOG ENTRY FORM  -->
        <!-- ========================= -->
        <h3>Skapa nytt inlägg</h3>

        <!-- NOTE: File upload requires full form submit, not AJAX -->
        <h:form styleClass="form-card" id="addBlogEntryForm" enctype="multipart/form-data">

            <div class="form-row">
                <label>Titel:</label>
                <h:inputText value="#{adminBean.newBlogEntry.title}" />
            </div>

            <div class="form-row">
                <label>Författare:</label>
                <h:inputText value="#{adminBean.newBlogEntry.name}" />
            </div>

            <div class="form-row">
                <label>Text:</label>
                <h:inputTextarea value="#{adminBean.newBlogEntry.entry}" rows="5"/>
            </div>

            <div class="form-row">
                <label>Bild:</label>
                <h:inputFile value="#{adminBean.uploadedPicture}" />
            </div>

            <div class="form-row center">
                <!-- Full submit for file upload - no AJAX -->
                <h:commandButton value="Publicera"
                                 action="#{adminBean.addBlogEntry}"
                                 styleClass="primary-btn"/>
            </div>

        </h:form>

    </div>

</h:body>
</html>
